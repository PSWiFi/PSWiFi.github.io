---
layout: default
title: PkParse
permalink: /misc/pkparse/
---

<h1 class="mb-0 pb-0">PkParse</h1>
<small class="text-muted mb-3 mt-0"
  >by
  <a
    class="text-decoration-none text-muted"
    href="https://github.com/LegoFigure11"
    >LegoFigure11</a
  ></small
>

<hr />

<div class="mb-3">
  <input
    type="file"
    class="form-control"
    id="formFile"
    name="formFile"
    accept=".pk9,.pk8,.pa8,.pb8,.pk7,.pk6"
    multiple
  />
</div>

<div class="mb-2">
  <label for="format">Output format:</label>
  <input
    type="text"
    class="form-control"
    id="format"
    name="format"
    value="%species%%gmax%\t%shiny-type-symbol-long%\t%ot%\t%tid%\t%sid%\t%ivhp-judge%/%ivatk-judge%/%ivdef-judge%/%ivspa-judge%/%ivspd-judge%/%ivspe-judge%\t%ivhp%/%ivatk%/%ivdef%/%ivspa%/%ivspd%/%ivspe%\t%nature%\t%gender-symbol%\t\t%ball%\t\t%origingame%"
  />
</div>

<div class="mb-3">
  <button
    class="btn btn-primary w-100"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#opts-collapse"
    aria-expanded="false"
    aria-controls="opts-collapse"
  >
    All Output Options...
  </button>
  <div class="collapse" id="opts-collapse">
    <div class="card card-body" id="opts-container">
      <!-- Generated dynamically, see generateOutputOptions() in /data/utils.js -->
    </div>
  </div>
</div>

<hr />

<div id="results-container"></div>

<script>
  var e = document.getElementById("formFile");
  e.addEventListener("change", handleUpload);

  $(document).ready(function () {
    generateOutputOptions();
  });

  function handleUpload() {
    var container = document.getElementById("results-container");
    while (container.firstChild) {
      container.removeChild(container.lastChild);
    }
    process(e.files);
  }

  // Putting this in a recursive delayed loop allows time to clear the buffer, helping to prevent bad reads and race conditions
  function process(files, delay = 150, i = 0) {
    if (i >= files.length) {
      return i >= 2 ? generateCopyAllButton() : 0;
    }

    var file = files[i];
    var fname = file.name;
    var ext = fname.substring(fname.lastIndexOf("."));

    var gen,
      idsloc,
      abilityloc,
      abilitynumloc,
      pidloc,
      speciesloc,
      otloc,
      gmaxloc,
      ivsloc,
      natureloc,
      statnatureloc,
      fatefulloc,
      genderloc,
      ballloc,
      ogloc,
      htflagsloc;

    // Sanity check file sizes and get offsets
    switch (ext) {
      case ".pk9": // SV
        if (file.size != SIZE_9)
          return alert(
            "Incorrect file size!\nExpected: " + SIZE_9 + "\nGot: " + file.size
          );
        speciesloc = 0x08;
        idsloc = 0x0c;
        abilityloc = 0x14;
        abilitynumloc = 0x16;
        pidloc = 0x1c;
        natureloc = 0x20;
        statnatureloc = 0x21;
        fatefulloc = 0x22;
        genderloc = 0x22;
        ivsloc = 0x8c;
        ogloc = 0xce;
        otloc = 0xf8;
        ballloc = 0x124;
        htflagsloc = 0x126;
        gen = 9;
        break;

      case ".pa8": // LA
        if (file.size != SIZE_8A)
          return alert(
            "Incorrect file size!\nExpected: " + SIZE_8A + "\nGot: " + file.size
          );
        speciesloc = 0x08;
        idsloc = 0x0c;
        abilityloc = 0x14;
        abilitynumloc = 0x16;
        pidloc = 0x1c;
        natureloc = 0x20;
        statnatureloc = 0x21;
        fatefulloc = 0x22;
        genderloc = 0x22;
        ogloc = 0xee;
        ivsloc = 0x94;
        otloc = 0x110;
        ballloc = 0x137;
        htflagsloc = 0x13e;
        gen = 8;
        break;

      case ".pk8": // SWSH
      case ".pb8": // BDSP
        if (file.size != SIZE_8)
          return alert(
            "Incorrect file size!\nExpected: " + SIZE_8 + "\nGot: " + file.size
          );
        speciesloc = 0x08;
        idsloc = 0x0c;
        abilityloc = 0x14;
        abilitynumloc = 0x16;
        gmaxloc = 0x16;
        pidloc = 0x1c;
        natureloc = 0x20;
        statnatureloc = 0x21;
        fatefulloc = 0x22;
        genderloc = 0x22;
        ivsloc = 0x8c;
        ogloc = 0xde;
        otloc = 0xf8;
        ballloc = 0x124;
        htflagsloc = 0x126;
        gen = 8;
        break;

      case ".pk7": // USUM
        if (file.size != SIZE_7)
          return alert(
            "Incorrect file size!\nExpected: " + SIZE_7 + "\nGot: " + file.size
          );
        speciesloc = 0x08;
        idsloc = 0x0c;
        abilityloc = 0x14;
        abilitynumloc = 0x15;
        pidloc = 0x18;
        natureloc = 0x1c;
        fatefulloc = 0x1d;
        genderloc = 0x1d;
        ivsloc = 0x74;
        otloc = 0xb0;
        ballloc = 0xdc;
        htflagsloc = 0xde;
        ogloc = 0xdf;
        gen = 7;
        break;

      case ".pk6": // XYORAS
        if (file.size != SIZE_6)
          return alert(
            "Incorrect file size!\nExpected: " + SIZE_6 + "\nGot: " + file.size
          );
        speciesloc = 0x08;
        idsloc = 0x0c;
        abilityloc = 0x14;
        abilitynumloc = 0x15;
        pidloc = 0x18;
        natureloc = 0x1c;
        fatefulloc = 0x1d;
        genderloc = 0x1d;
        ivsloc = 0x74;
        otloc = 0xb0;
        ballloc = 0xdc;
        ogloc = 0xdf;
        gen = 6;
        break;

      default: // Should never happen
        return alert("Unsupported file type provided: " + fname);
    }

    file.arrayBuffer().then((buf) => {
      var otarrbuf = buf.slice(otloc, otloc + 26);
      var ot = getStringFromBuffer(new DataView(otarrbuf));
      var data = new DataView(buf);
      var devid = data.getUint16(speciesloc, true);
      var species = gen === 9 ? getSpecies9(devid) : SPECIES[devid];
      var pid = data.getUint32(pidloc, true);
      var gmax = gmaxloc ? (data.getUint8(gmaxloc) & 16) !== 0 : false;

      var ability = data.getUint8(abilityloc);
      var abilitynum = data.getUint8(abilitynumloc) & 7; // & 7 not used in Gen 6 but has no effect on resulting value

      var ids = data.getUint32(idsloc, true);
      var tid5 = ids & 0xffff;
      var sid5 = ids >>> 16;
      var fullid = sid5 * 65536 + tid5;
      var tid7 = fullid % 1000000;
      var sid7 = ~~(fullid / 1000000);
      var tid =
        (ogval >= 30) & (ogval <= 34) || ogval >= 42
          ? tid7.toString().padStart(6, "0")
          : tid5.toString().padStart(5, "0");
      var sid =
        (ogval >= 30) & (ogval <= 34) || ogval >= 42
          ? sid7.toString().padStart(4, "0")
          : sid5.toString().padStart(5, "0");
      var fateful = (data.getUint8(fatefulloc) & 1) === 1;
      var shinyxor = (pid >>> 16) ^ (pid & 0xffff) ^ tid5 ^ sid5;
      var shinytype =
        (shinyxor < 16 && fateful) || shinyxor === 0
          ? 2
          : shinyxor < 16
          ? 1
          : 0;
      var nature = NATURES[data.getUint8(natureloc)];
      var statnature = statnatureloc
        ? NATURES[data.getUint8(statnatureloc)]
        : nature;
      var gender = (data.getUint8(genderloc) >>> (gen === 8 ? 2 : 1)) & 0x3;
      var iv32 = data.getUint32(ivsloc, true);

      var hpType = calcHPType(iv32);
      var hpPower = calcHPPower(iv32);

      var ivs = [
        (iv32 >>> 0) & 0x1f,
        (iv32 >>> 5) & 0x1f,
        (iv32 >>> 10) & 0x1f,
        (iv32 >>> 20) & 0x1f,
        (iv32 >>> 25) & 0x1f,
        (iv32 >>> 15) & 0x1f,
      ];
      var judge = [];
      for (var i = 0; i < ivs.length; i++) {
        var j = ivs[i];
        if (j === 31) judge.push("B");
        else if (j === 30) judge.push("F");
        else if (j >= 26) judge.push("VG");
        else if (j >= 16) judge.push("PG");
        else if (j >= 1) judge.push("D");
        else judge.push("NG");
      }
      var htFlags = htflagsloc ? data.getUint8(htflagsloc) : 0;
      var ht = [
        ((htFlags >> 0) & 1) == 1,
        ((htFlags >> 1) & 1) == 1,
        ((htFlags >> 2) & 1) == 1,
        ((htFlags >> 3) & 1) == 1,
        ((htFlags >> 4) & 1) == 1,
        ((htFlags >> 5) & 1) == 1,
      ];
      var [ivhp, ivatk, ivdef, ivspa, ivspd, ivspe] = ivs;
      var [jhp, jatk, jdef, jspa, jspd, jspe] = judge;
      var ivsht = [];
      var jht = [];
      for (var i = 0; i < ht.length; i++) {
        var isht = ht[i];
        ivsht.push(isht ? "HT" : ivs[i]);
        jht.push(isht ? "HT" : judge[i]);
      }
      var [ivhpht, ivatkht, ivdefht, ivspaht, ivspdht, ivspeht] = ivsht;
      var [jhpht, jatkht, jdefht, jspaht, jspdht, jspeht] = jht;

      var ball = BALLS[data.getUint8(ballloc)];
      var ogval = data.getUint8(ogloc);
      var origingame = ORIGIN_GAMES[ogval];

      var outstr = document.getElementById("format").value?.toLowerCase();
      if (!outstr)
        outstr =
          "%species%%gmax%\t%shiny-type-symbol-long%\t%ot%\t%tid%\t%sid%\t%ivhp-judge%/%ivatk-judge%/%ivdef-judge%/%ivspa-judge%/%ivspd-judge%/%ivspe-judge%\t%ivhp%/%ivatk%/%ivdef%/%ivspa%/%ivspd%/%ivspe%\t%nature%\t%gender-symbol%\t\t%ball%\t\t%origingame%";

      // Commence custom parser logic
      if (outstr.includes("\\t")) outstr = outstr.replace(/\\t/g, "\t");
      if (outstr.includes("\\n")) outstr = outstr.replace(/\\n/g, "\r\n");

      if (outstr.includes("%gen%")) outstr = outstr.replace(/\%gen\%/g, gen);
      if (outstr.includes("%gen-roman%"))
        outstr = outstr.replace(/\%gen-roman\%/g, roman(gen));
      if (outstr.includes("%dex%"))
        outstr = outstr.replace(/\%dex\%/g, getNational9(devid));
      if (outstr.includes("%species%"))
        outstr = outstr.replace(/\%species\%/g, species);
      if (outstr.includes("%gmax%"))
        outstr = outstr.replace(/\%gmax\%/, gmax ? "-Gmax" : "");

      if (outstr.includes("%origingame%"))
        outstr = outstr.replace(/\%origingame\%/g, origingame);
      if (outstr.includes("%ball%")) outstr = outstr.replace(/\%ball\%/g, ball);
      if (outstr.includes("%ot%")) outstr = outstr.replace(/\%ot\%/g, ot);
      if (outstr.includes("%tid%")) outstr = outstr.replace(/\%tid\%/g, tid);
      if (outstr.includes("%sid%")) outstr = outstr.replace(/\%sid\%/g, sid);
      if (outstr.includes("%tid5%"))
        outstr = outstr.replace(/\%tid5\%/g, tid5.toString().padStart(5, "0"));
      if (outstr.includes("%sid5%"))
        outstr = outstr.replace(/\%sid5\%/g, sid5.toString().padStart(5, "0"));
      if (outstr.includes("%tid7%"))
        outstr = outstr.replace(/\%tid7\%/g, tid7.toString().padStart(6, "0"));
      if (outstr.includes("%sid7%"))
        outstr = outstr.replace(/\%sid7\%/g, sid7.toString().padStart(4, "0"));
      if (outstr.includes("%gender%"))
        outstr = outstr.replace(/\%gender\%/g, GENDER[gender]);
      if (outstr.includes("%gender-upper%"))
        outstr = outstr.replace(/\%gender-upper\%/g, GENDER_UPPER[gender]);
      if (outstr.includes("%gender-symbol%"))
        outstr = outstr.replace(/\%gender-symbol\%/g, GENDER_SYMBOL[gender]);

      if (outstr.includes("%pid%"))
        outstr = outstr.replace(/\%pid\%/g, pid.toString(16).padStart(8, "0"));
      if (outstr.includes("%pid-upper%"))
        outstr = outstr.replace(
          /\%pid-upper\%/g,
          pid.toString(16).padStart(8, "0").toUpperCase()
        );
      if (outstr.includes("%shiny%"))
        outstr = outstr.replace(/\%shiny\%/g, shinytype === 0 ? "y" : "n");
      if (outstr.includes("%shiny-upper%"))
        outstr = outstr.replace(
          /\%shiny-upper\%/g,
          shinytype === 0 ? "Y" : "N"
        );
      if (outstr.includes("%shiny-long%"))
        outstr = outstr.replace(
          /\%shiny-long\%/g,
          shinytype === 0 ? "yes" : "no"
        );
      if (outstr.includes("%shiny-long-upper%"))
        outstr = outstr.replace(
          /\%shiny-long-upper\%/g,
          shinytype === 0 ? "Yes" : "No"
        );
      if (outstr.includes("%shiny-type-symbol%"))
        outstr = outstr.replace(
          /\%shiny-type-symbol\%/g,
          SHINY_SYMBOL[shinytype]
        );
      if (outstr.includes("%shiny-type-symbol-upper%"))
        outstr = outstr.replace(
          /\%shiny-type-symbol-upper\%/g,
          toTitleCase(SHINY_SYMBOL[shinytype])
        );
      if (outstr.includes("%shiny-type-long%"))
        outstr = outstr.replace(/\%shiny-type-long\%/g, SHINY_LONG[shinytype]);
      if (outstr.includes("%shiny-type-long-upper%"))
        outstr = outstr.replace(
          /\%shiny-type-long-upper\%/g,
          toTitleCase(SHINY_LONG[shinytype])
        );
      if (outstr.includes("%shiny-type-symbol-long%"))
        outstr = outstr.replace(
          /\%shiny-type-symbol-long\%/g,
          SHINY_SYMBOL_LONG[shinytype]
        );
      if (outstr.includes("%shiny-type-symbol-long-upper%"))
        outstr = outstr.replace(
          /\%shiny-type-symbol-long-upper\%/g,
          toTitleCase(SHINY_SYMBOL_LONG[shinytype])
        );
      if (outstr.includes("%nature%"))
        outstr = outstr.replace(/\%nature\%/g, nature);
      if (outstr.includes("%nature-minted%"))
        outstr = outstr.replace(/\%nature-minted\%/g, statnature);
      if (outstr.includes("%ability%"))
        outstr = outstr.replace(/\%ability\%/g, ABILITIES[ability]);
      if (outstr.includes("%abilitynum%"))
        outstr = outstr.replace(
          /\%abilitynum\%/g,
          abilitynum === 4 ? "h" : abilitynum
        );
      if (outstr.includes("%abilitynum-upper%"))
        outstr = outstr.replace(
          /\%abilitynum-upper\%/g,
          abilitynum === 4 ? "H" : abilitynum
        );

      if (outstr.includes("%ivhp%")) outstr = outstr.replace(/\%ivhp\%/g, ivhp);
      if (outstr.includes("%ivhp-judge%"))
        outstr = outstr.replace(/\%ivhp-judge\%/g, jhp);
      if (outstr.includes("%ivhp-ht%"))
        outstr = outstr.replace(/\%ivhp-ht\%/g, ivhpht);
      if (outstr.includes("%ivhp-judge-ht%"))
        outstr = outstr.replace(/\%ivhp-judge-ht\%/g, jhpht);
      if (outstr.includes("%ivatk%"))
        outstr = outstr.replace(/\%ivatk\%/g, ivatk);
      if (outstr.includes("%ivatk-judge%"))
        outstr = outstr.replace(/\%ivatk-judge\%/g, jatk);
      if (outstr.includes("%ivatk-ht%"))
        outstr = outstr.replace(/\%ivatk-ht\%/g, ivatkht);
      if (outstr.includes("%ivatk-judge-ht%"))
        outstr = outstr.replace(/\%ivatk-judge-ht\%/g, jatkht);
      if (outstr.includes("%ivdef%"))
        outstr = outstr.replace(/\%ivdef\%/g, ivdef);
      if (outstr.includes("%ivdef-judge%"))
        outstr = outstr.replace(/\%ivdef-judge\%/g, jdef);
      if (outstr.includes("%ivdef-ht%"))
        outstr = outstr.replace(/\%ivdef-ht\%/g, ivdefht);
      if (outstr.includes("%ivdef-judge-ht%"))
        outstr = outstr.replace(/\%ivdef-judge-ht\%/g, jdefht);
      if (outstr.includes("%ivspa%"))
        outstr = outstr.replace(/\%ivspa\%/g, ivspa);
      if (outstr.includes("%ivspa-judge%"))
        outstr = outstr.replace(/\%ivspa-judge\%/g, jspa);
      if (outstr.includes("%ivspa-ht%"))
        outstr = outstr.replace(/\%ivspa-ht\%/g, ivspaht);
      if (outstr.includes("%ivspa-judge-ht%"))
        outstr = outstr.replace(/\%ivspa-judge-ht\%/g, jspaht);
      if (outstr.includes("%ivspd%"))
        outstr = outstr.replace(/\%ivspd\%/g, ivspd);
      if (outstr.includes("%ivspd-judge%"))
        outstr = outstr.replace(/\%ivspd-judge\%/g, jspd);
      if (outstr.includes("%ivspd-ht%"))
        outstr = outstr.replace(/\%ivspd-ht\%/g, ivspdht);
      if (outstr.includes("%ivspd-judge-ht%"))
        outstr = outstr.replace(/\%ivspd-judge-ht\%/g, jspdht);
      if (outstr.includes("%ivspe%"))
        outstr = outstr.replace(/\%ivspe\%/g, ivspe);
      if (outstr.includes("%ivspe-judge%"))
        outstr = outstr.replace(/\%ivspe-judge\%/g, jspe);
      if (outstr.includes("%ivspe-ht%"))
        outstr = outstr.replace(/\%ivspe-ht\%/g, ivspeht);
      if (outstr.includes("%ivspe-judge-ht%"))
        outstr = outstr.replace(/\%ivspe-judge-ht\%/g, jspeht);
      if (outstr.includes("%hp-type"))
        outstr = outstr.replace(/\%hp-type\%/, hpType);
      if (outstr.includes("%hp-power"))
        outstr = outstr.replace(/\%hp-power\%/, hpPower);

      // End custom parser logic

      var elem = document.createElement("div");
      elem.classList.add("card", "mb-3", "border-success");

      var cardHeader = document.createElement("div");
      cardHeader.classList.add("card-header");

      var headerRow = document.createElement("div");
      headerRow.classList.add("row");

      var cardTitle = document.createElement("div");
      cardTitle.classList.add("col", "col-10");
      cardTitle.setAttribute("style", "padding-top: 0.375rem;");
      cardTitle.textContent = fname;
      headerRow.appendChild(cardTitle);

      var copyButtonContainer = document.createElement("div");
      copyButtonContainer.classList.add("col", "col-2", "d-flex");

      var copyButton = document.createElement("button");
      copyButton.classList.add("btn", "btn-success", "ms-auto", "copy-button");
      copyButton.textContent = "\u{1F4CB}";
      copyButton.setAttribute("data-copy-value", outstr);

      copyButtonContainer.appendChild(copyButton);
      headerRow.appendChild(copyButtonContainer);
      cardHeader.appendChild(headerRow);
      elem.appendChild(cardHeader);

      var cardBody = document.createElement("div");
      cardBody.classList.add("card-body");
      cardBody.textContent = outstr;
      elem.appendChild(cardBody);

      document.getElementById("results-container").appendChild(elem);

      copyButton.addEventListener("click", copyContent);
    });

    i++;

    setTimeout(() => {
      process(files, delay, i);
    }, delay);
  }
</script>
<script type="text/javascript" src="./data/outputOptions.js"></script>
<script type="text/javascript" src="./data/size.js"></script>
<script type="text/javascript" src="./data/ability.js"></script>
<script type="text/javascript" src="./data/nature.js"></script>
<script type="text/javascript" src="./data/ball.js"></script>
<script type="text/javascript" src="./data/gender.js"></script>
<script type="text/javascript" src="./data/originGame.js"></script>
<script type="text/javascript" src="./data/species.js"></script>
<script type="text/javascript" src="./data/shiny.js"></script>
<script type="text/javascript" src="./data/type.js"></script>
<script type="text/javascript" src="./data/utils.js"></script>
